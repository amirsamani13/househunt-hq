<!DOCTYPE html>
<html>
<head>
    <title>Test Property Notifications</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        button { background: #2563eb; color: white; padding: 10px 20px; border: none; border-radius: 5px; margin: 10px; cursor: pointer; }
        button:hover { background: #1d4ed8; }
        .log { background: #f3f4f6; padding: 20px; border-radius: 5px; margin: 20px 0; white-space: pre-wrap; }
        .success { color: #059669; }
        .error { color: #dc2626; }
    </style>
</head>
<body>
    <h1>Test Property Notification System</h1>
    
    <button onclick="runScraper()">1. Run Property Scraper</button>
    <button onclick="runNotifications()">2. Send Notifications</button>
    <button onclick="testBoth()">3. Test Complete Flow</button>
    <button id="stopBtn" onclick="stopTesting()" style="background:#dc2626">Stop / Pause</button>
    
    <div style="margin-top:10px">
      <input id="testEmail" type="email" placeholder="Your email for test" style="padding:8px;border:1px solid #e5e7eb;border-radius:6px;min-width:280px"/>
      <button onclick="runTestEmail()">4. Send Test Email</button>
    </div>
    
    <div id="log" class="log">Ready to test...</div>

    <script>
        const supabaseUrl = 'https://oxdneiaojgwezxltivcl.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im94ZG5laWFvamd3ZXp4bHRpdmNsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM3MDY5ODUsImV4cCI6MjA2OTI4Mjk4NX0.8jK-YtcqCshUDP1UgYzZLg8efcqfSl5oHK2a1ghqgAI';
        
        // Test controls
        let currentController = null; // AbortController
        let stopRequested = false;
        
        // Prefill test email from localStorage
        const savedEmail = localStorage.getItem('testEmail');
        if (savedEmail) {
          setTimeout(() => {
            const input = document.getElementById('testEmail');
            if (input) input.value = savedEmail;
          }, 0);
        }
        
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            logEl.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        async function callFunction(functionName, method = 'POST', body = null) {
            try {
                if (stopRequested) {
                    log(`‚è∏Ô∏è Skipped ${functionName} because test is paused`);
                    return null;
                }
                log(`Calling ${functionName}...`);
                currentController = new AbortController();
                const response = await fetch(`${supabaseUrl}/functions/v1/${functionName}`, {
                    method,
                    headers: {
                        'Authorization': `Bearer ${supabaseKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: body ? JSON.stringify(body) : null,
                    signal: currentController.signal
                });
                
                const text = await response.text();
                if (response.ok) {
                    log(`‚úÖ ${functionName} completed successfully`, 'success');
                    log(`Response: ${text}`);
                    try { return JSON.parse(text); } catch { return text; }
                } else {
                    log(`‚ùå ${functionName} failed: ${text}`, 'error');
                    return null;
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    log(`‚õî ${functionName} aborted.`, 'error');
                    return null;
                }
                log(`‚ùå Error calling ${functionName}: ${error.message}`, 'error');
                return null;
            } finally {
                currentController = null;
            }
        }

        async function runScraper() {
            log('üï∑Ô∏è Starting property scraper...');
            await callFunction('scrape-properties');
        }

        async function runNotifications() {
            log('üìß Starting notification sender...');
            await callFunction('send-notifications');
        }

        async function runTestEmail() {
            const input = document.getElementById('testEmail');
            const to = input?.value?.trim();
            if (!to) {
              log('Please enter an email address to send the test to.', 'error');
              return;
            }
            localStorage.setItem('testEmail', to);
            log(`üì® Sending test email to ${to}...`);
            await callFunction('send-test-email', 'POST', { to });
            log('‚úÖ Test email finished (single run).', 'success');
        }

        function stopTesting() {
            stopRequested = true;
            if (currentController) {
              try { currentController.abort(); } catch {}
            }
            log('‚èπÔ∏è Testing paused/stopped. No further steps will run.');
        }

        async function testBoth() {
            stopRequested = false;
            log('üß™ Starting complete notification test flow...');
            log('Step 1: Running scraper to get fresh properties...');
            await runScraper();
            if (stopRequested) return log('‚èπÔ∏è Flow stopped after scraper.');

            log('Waiting 3 seconds before sending notifications...');
            await new Promise((r) => setTimeout(r, 3000));
            if (stopRequested) return log('‚èπÔ∏è Flow stopped before sending notifications.');

            log('Step 2: Checking for matches and sending notifications...');
            await runNotifications();
            log('‚úÖ Complete test flow finished (single run).', 'success');
        }
    </script>
</body>
</html>